name: 'Deploy HelmFile'
description: 'Deploy on Kubernetes with HelmFile'
author: amrut@eqx.vc
branding:
  icon: 'file-text'
  color: 'white'
inputs:
  cluster:
    description: Cluster name
    required: true
  aws-region:
    description: AWS region
    required: false
    default: us-east-1
  helmfile-path:
    description: The path where lives the helmfile.
    required: false
    default: deploy
  helmfile:
    description: Helmfile name
    required: false
    default: helmfile.yaml
  include-needs:
    description: Include crd needs in helmfile
    required: false
    default: false
  operation:
    description: Operation with helmfiles. (valid options - `apply`, `destroy`, `sync`)
    required: true
    default: apply
  environment:
    description: Helmfile environment
    required: false
    default: preview
  gitref-sha:
    description: Git SHA
    required: false
    default: ''
  namespace:
    description: Kubernetes namespace
    required: false
  image:
    description: Docker image
    required: false
  image-tag:
    description: Docker image tag
    required: false
  debug:
    description: Debug mode
    default: 'false'
    required: false
  release_label_name:
    description: The name of the label used to describe the helm release
    default: "release"
    required: false
  values_yaml:
    description: YAML string with extra values to use in a helmfile deploy
    required: false
  helm_version:
    description: Helm version
    default: 3.18.4
  helmfile_version:
    description: Helmfile version
    default: 1.1.3
  kubectl_version:
    description: Kubectl version
    default: 1.26.3
  chamber_version:
    description: Kubectl version
    default: 2.11.1
  deploy-to-aws:
    description: Whether to deploy to AWS EKS cluster
    required: false
    default: 'true'
outputs:
  webapp-url:
    description: "Web Application url"
runs:
  using: 'docker'
  image: 'Dockerfile'
  env:
    AWS_REGION: ${{ inputs.aws-region }}
    ENVIRONMENT: ${{ inputs.environment }}
    HELM_VALUES_YAML: ${{ inputs.values_yaml }}
    HELMFILE: ${{ inputs.helmfile }}
    INCLUDE_NEEDS: ${{ inputs.include-needs }}
    HELMFILE_PATH: ${{ inputs.helmfile-path }}
    NAMESPACE: ${{ inputs.namespace }}
    IMAGE_NAME: ${{ inputs.image }}
    IMAGE_TAG: ${{ inputs.image-tag }}
    OPERATION: ${{ inputs.operation }}
    GITREF_SHA: ${{ inputs.gitref-sha }}
    CLUSTER_NAME: ${{ inputs.cluster }}
    HELM_DEBUG: ${{ inputs.debug }}
    RELEASE_LABEL_NAME: ${{ inputs.release_label_name }}
    KUBECTL_VERSION: ${{ inputs.kubectl_version }}
    HELM_VERSION: ${{ inputs.helm_version }}
    HELMFILE_VERSION: ${{ inputs.helmfile_version }}
    CHAMBER_VERSION: ${{ inputs.chamber_version }}
    DEPLOY_TO_AWS: ${{ inputs.deploy-to-aws }}
